{% extends "base.html" %}

{% block body %}
<video id="camera" class="center-in-screen"></video>
<a href="#" class="btn center-in-screen" id="capture-btn" disabled>Capture</a>
<canvas id="canvas" class="hide"></canvas>
<div id="predict-loading-wrapper" class="hide">
    <div class="preloader-wrapper big active center-in-screen">
        <div class="spinner-layer spinner-green-only">
            <div class="circle-clipper left"><div class="circle"></div></div>
            <div class="gap-patch"><div class="circle"></div></div>
            <div class="circle-clipper right"><div class="circle"></div></div>
        </div>
    </div>
</div>
<div class="modal" id="camera-permission-modal">
    <div class="modal-content">
        <h3>Permission Required</h3>
        <p>HiWaste needs camera permission to be able to classify your waste.</p>
        <hr>
        <p>Alternatively, if you already taken photo and want to upload a file instead, press the button below</p>
    </div>
</div>
<div class="modal" id="no-camera-modal">
    <div class="modal-content">
        <h3>No Camera</h3>
        <p>Currently you blocked access to camera, or your browser is not supported.</p>
        <hr>
        <p>Alternatively, if you already taken photo and want to upload a file instead, press the button below</p>
    </div>
</div>
<div id="predict-results-box" class="card center-in-screen hide">
    <ul class="collection with-header">
        <li class="collection-header"><h5>Prediction results</h5></li>
        <a href="#" class="collection-item" target="_blank"></a>
        <a href="#" class="collection-item" target="_blank"></a>
    </ul>
</div>
<script>
let cameraPermissionDone = false;
let cameraPermissionModal = M.Modal.init(document.querySelector("#camera-permission-modal"), {
    'dismissible': false,
    'endingTop': '20%'
});
let cameraStream = null;
let cameraEl = document.querySelector("#camera");
let canvasEl = document.querySelector("#canvas");
let captureBtnEl = document.querySelector("#capture-btn");
let predictLoadingWrapper = document.querySelector("#predict-loading-wrapper");
let predictResultsBox = document.querySelector("#predict-results-box");
if ('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices) {
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            postCameraPermission();
            captureBtnEl.removeAttribute("disabled");
            cameraEl.srcObject = stream;
            cameraEl.play();
            cameraStream = stream;
        }).catch(showNoCamera);
} else {
    showNoCamera("not supported");
}
function postCameraPermission() {
    cameraPermissionDone = true;
    cameraPermissionModal.close();
}
function showNoCamera(reason) {
    postCameraPermission();
    M.Modal.init(document.querySelector("#no-camera-modal"), {
        'dismissible': false
    }).open();
    console.error(reason);
}
setTimeout(() => {
    if (cameraPermissionDone)
        return;
    cameraPermissionModal.open();
}, 1000);
captureBtnEl.onclick = () => {
    captureBtnEl.setAttribute("disabled", true);
    predictLoadingWrapper.classList.remove("hide");
    let canvasContext = canvas.getContext('2d');
    cameraEl.pause();
    canvasEl.width = cameraEl.videoWidth;
    canvasEl.height = cameraEl.videoHeight;
    canvasContext.drawImage(cameraEl, 0, 0, canvasEl.width, canvasEl.height);
    cameraStream.getTracks().forEach(track => track.stop());
    data = JSON.stringify({
        imgBase64: canvasEl.toDataURL("image/jpeg")
    });
    fetch("{% url 'predict' %}", {
        method: "POST",
        headers: {
            'X-CSRFToken': Cookies.get('csrftoken')
        },
        body: data
    }).then(res => res.json())
    .then((results) => {
        predictLoadingWrapper.classList.add("hide");
        let resultItems = predictResultsBox.querySelectorAll(".collection-item");
        results.forEach((item, index) => {
            let resultHtml = item.name[0].toUpperCase() + item.name.slice(1);
            resultHtml += '<span class="right">' + (item.confident * 100).toFixed(2) + '%</span>';
            resultItems[index].innerHTML = resultHtml;
            resultItems[index].href = "{% url 'category_noparam' %}/" + item.name;
        });
        predictResultsBox.classList.remove("hide");
    });
    return false;
}
</script>
{% endblock %}